version: "3.9"

name: radio-francine

services:
  app:
    build:
      context: .
      target: app
      args:
        WWWUSER: ${WWWUSER:-1000}
        WWWGROUP: ${WWWGROUP:-1000}
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: https://radio-francine.c0chett0.dev
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME:-radio}
      DB_PASSWORD: ${DB_PASSWORD:-radio}
      DB_DATABASE: ${DB_DATABASE:-radio}
      REDIS_HOST: ${REDIS_HOST:-redis}
    networks:
      - internal
    depends_on:
      - db
      - redis

  web:
    build:
      context: .
      target: web
    networks:
      - internal
      - traefik
    depends_on:
      - app
    labels:
      - traefik.enable=true
      - traefik.http.routers.radio-francine.rule=Host(`radio-francine.c0chett0.dev`)
      - traefik.http.routers.radio-francine.entrypoints=websecure
      - traefik.http.routers.radio-francine.tls=true
      - traefik.http.services.radio-francine.loadbalancer.server.port=80

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: radio
      POSTGRES_PASSWORD: radio
      POSTGRES_DB: radio
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - internal

  redis:
    image: redis:7-alpine
    networks:
      - internal

  queue:
    build:
      context: .
      target: app
      args:
        WWWUSER: ${WWWUSER:-1000}
        WWWGROUP: ${WWWGROUP:-1000}
    command: php artisan queue:work --tries=3 --backoff=3
    depends_on:
      - app
      - redis
    networks:
      - internal

networks:
  internal:
  traefik:
    external: true

volumes:
  db-data:

